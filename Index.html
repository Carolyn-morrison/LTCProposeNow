<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProposeNow by Long‑Term Consultants</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --teal-900: #0b343c; /* brand deep teal */
      --teal-600: #3b6269;
      --teal-400: #58b4c3; /* accent */
      --teal-200: #d5eaea; /* light */
      --bg: #f6fbfb;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--teal-900);}    
    .wrap { max-width: 980px; margin: 32px auto; padding: 24px; }
    .warn { background: #fff4e5; border:1px solid #f7c97b; color:#7a4b00; padding:12px 14px; border-radius:12px; margin:16px 0; font-size:13px; }
    .testbox { background:#ffffff; border:1px dashed var(--teal-400); border-radius:12px; padding:12px; margin-top:12px; font-size:13px; color:var(--teal-600);} 
    .testbox code { background:#f3fbfc; padding:2px 6px; border-radius:6px; }
    .ok { color:#116b3b; font-weight:600; }
    .bad { color:#a61b1b; font-weight:600; }
    .brand { display:flex; align-items:center; gap:16px; padding:16px 20px; background: white; border:1px solid var(--teal-200); border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.06);}    
    .logo { width:48px; height:48px; border-radius: 12px; background: linear-gradient(135deg, var(--teal-400), var(--teal-600)); display:flex; align-items:center; justify-content:center; color:white; font-weight:800; letter-spacing:0.5px; overflow:hidden; }
    h1 { margin: 0; font-size: 22px; line-height:1.2; }
    .subtitle { font-size:13px; color: var(--teal-600); }

    form { margin-top: 20px; background:white; border:1px solid var(--teal-200); border-radius: 16px; padding: 20px; box-shadow: 0 6px 24px rgba(0,0,0,0.06);}    
    fieldset { border: none; margin: 0; padding: 0; }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }

    label { display:block; font-size: 12px; font-weight:600; color: var(--teal-600); margin-bottom:6px; }
    input, select, textarea { width:100%; padding: 10px 12px; border: 1px solid var(--teal-200); border-radius: 10px; font-size: 14px; }
    textarea { min-height: 88px; resize: vertical; }

    .radio-row { display:flex; gap:16px; }
    .radio { display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--teal-200); border-radius: 10px; }

    .actions { display:flex; gap:12px; margin-top: 16px; }
    button { border: none; background: var(--teal-900); color:white; padding: 12px 16px; border-radius: 12px; font-weight:700; cursor:pointer; }
    button.secondary { background: transparent; color: var(--teal-900); border:1px solid var(--teal-200); }

    .note { margin-top: 12px; font-size: 12px; color: var(--teal-600); }
    .foot { margin-top: 18px; font-size: 12px; color: var(--teal-600); text-align:center; }

    
    /* Logo image styling */
    .logo img { width:100%; height:100%; object-fit:contain; display:block; }  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"><img id="logoImg" src="logo.png" alt="Long‑Term Consultants logo" /></div>
      <div>
        <h1>ProposeNow by Long‑Term Consultants <span style="font-weight:600; color:var(--teal-600)"> (in partnership with Allstate)</span></h1>
        <div class="subtitle">Generate a branded, flat PDF proposal from your selected template — automatically mapped from employee count & proposal type.</div>
      <div id="envWarn" class="warn" style="display:none">You're opening this file directly from your computer (<code>file://</code>). Browsers block loading local PDFs this way. Please host this folder on a local or cloud web server (e.g., <code>python -m http.server</code>, VS Code Live Server, SharePoint/OneDrive) so the templates can load.</div>
      </div>
    </div>

    <form id="proposalForm">
      <fieldset class="grid">
        <div class="col-6">
          <label for="proposalType">Type of Proposal</label>
          <div class="radio-row" id="proposalType">
            <label class="radio"><input type="radio" name="type" value="direct" checked> Long‑Term Consultants Direct</label>
            <label class="radio"><input type="radio" name="type" value="partner"> Partner Request</label>
          </div>
        </div>
        <div class="col-6">
          <label for="employees">Number of Employees</label>
          <input id="employees" name="employees" type="number" min="1" placeholder="e.g., 75" required>
        </div>
        

        <div class="col-6">
          <label for="preparedBy">Prepared By</label>
          <input id="preparedBy" name="Prepared By" placeholder="Your name / Long‑Term Consultants" required>
        </div>
        <div class="col-6">
          <label for="preparedFor">Prepared For</label>
          <input id="preparedFor" name="Prepared For" placeholder="Client contact name" required>
        </div>

        <div class="col-6">
          <label for="agentName">Agent/Broker Name</label>
          <input id="agentName" name="Agent/Broker Name" placeholder="Agent or Broker name">
        </div>
        <div class="col-6">
          <label for="agentDetails">Agent/Broker Details</label>
          <input id="agentDetails" name="Agent/Broker Details" placeholder="Email | Phone | Agency">
        </div>

        <div class="col-8">
          <label for="accountName">Account Name (used to name the PDF)</label>
          <input id="accountName" name="Account Name" placeholder="Acme Manufacturing, Inc." required>
        </div>
        <div class="col-4">
          <label for="eligibleLives">Eligible Lives</label>
          <input id="eligibleLives" name="Eligible Lives" type="number" min="1" placeholder="e.g., 120">
        </div>

        <div class="col-4">
          <label for="sic">SIC</label>
          <input id="sic" name="SIC" placeholder="e.g., 2834">
        </div>
        <div class="col-4">
          <label for="situsState">Situs State</label>
          <input id="situsState" name="Situs State" placeholder="e.g., NY">
        </div>
        <div class="col-4">
          <label for="effectiveDate">Effective Date</label>
          <input id="effectiveDate" name="Effective Date" type="date" required>
        </div>

        <div class="col-12 template-hint" id="templateHint"></div>
        <div class="col-12 actions">
          <button type="submit">Generate Proposal PDF</button>
          <button type="button" class="secondary" id="resetBtn">Reset</button>
          <button type="button" class="secondary" id="selfTestBtn" title="Check that all six templates are reachable">Run Template Self‑Test</button>
        </div>
        <div class="col-12 testbox" id="selfTestOut" style="display:none"></div>
        <div class="col-12 note"></div></div>
      </fieldset>
    </form>

    <div class="foot">© <span id="year"></span> Long‑Term Consultants. For internal and partner use only.</div>
  </div>

  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    // Base path for templates. Leave as './templates/' if hosting HTML + /templates together.
    // Or set to '' and put full HTTPS links in TEMPLATE_FILES entries (e.g., SharePoint/OneDrive '?download=1' links).
    const TEMPLATES_DIR = './templates/'; // Place the 6 PDFs here
    // File names should exactly match the provided templates
    const TEMPLATE_FILES = {
      small: {
        direct: 'LTC_Branded_3-99_Template.pdf',
        partner: 'LTC_Branded_3-99_Template_Partner.pdf'
      },
      mid: {
        direct: 'LTC_Branded_100-249_Template.pdf',
        partner: 'LTC_Branded_100-249_Template_Partner.pdf'
      },
      large: {
        direct: 'LTC_Branded_Over250_Template.pdf',
        partner: 'LTC_Branded_Over250_Template_Partner.pdf'
      }
    };

    function pickBand(employees) {
      if (employees >= 3 && employees <= 99) return 'small';
      if (employees >= 100 && employees <= 249) return 'mid';
      if (employees >= 250) return 'large';
      throw new Error('Employee count must be 3 or greater.');
    }

    function computeTemplatePath(employees, type) {
      const band = pickBand(Number(employees));
      const file = TEMPLATE_FILES[band][type];
      if (!file) throw new Error('Template not found for selection');
      // Support absolute URLs (SharePoint/OneDrive) OR relative filenames
      return /^https?:\/\//i.test(file) ? file : (TEMPLATES_DIR + file);
    }

    const templateHint = document.getElementById('templateHint');
    const form = document.getElementById('proposalForm');
    const resetBtn = document.getElementById('resetBtn');

    function currentSelectionHint() {
      const type = (new FormData(form)).get('type') || 'direct';
      const employees = Number(document.getElementById('employees').value || 0);
      if (!employees || employees < 3) {
        templateHint.textContent = '';
        return;
      }
      try {
        const path = computeTemplatePath(employees, type);
        templateHint.innerHTML = 'Selected: <strong>' + path.replace(TEMPLATES_DIR, '') + '</strong>';
      } catch (e) {
        templateHint.textContent = e.message;
      }
    }

    form.addEventListener('input', currentSelectionHint);

    resetBtn.addEventListener('click', () => {
      form.reset();
      templateHint.textContent = '';
    });

    document.getElementById('year').textContent = new Date().getFullYear();

    // Show env warning if needed
    if (location.protocol === 'file:') {
      document.getElementById('envWarn').style.display = '';
    }

    // --- Logo handling ---
    window.headerLogoDataUrl = null;
    const logoImgEl = document.getElementById('logoImg');
    const logoUploadEl = document.getElementById('logoUpload');

    async function blobToDataURL(blob){
      return new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(blob); });
    }

    // Try to preload ./logo.png if it exists
    (async () => {
      try {
        const res = await fetch('logo.png');
        if (res.ok) {
          const b = await res.blob();
          window.headerLogoDataUrl = await blobToDataURL(b);
          logoImgEl.src = window.headerLogoDataUrl;
        }
      } catch (e) { /* ignore if missing */ }
    })();

    logoUploadEl?.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (file.type !== 'image/png') { alert('Please upload a PNG logo.'); return; }
      const dataUrl = await blobToDataURL(file);
      window.headerLogoDataUrl = dataUrl;
      logoImgEl.src = dataUrl;
    });

    async function fetchTemplateBytes(path) {
      try {
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error('HTTP ' + res.status + ' fetching ' + path + ' — check filename, path, and hosting.');
        }
        return new Uint8Array(await res.arrayBuffer());
      } catch (e) {
        const hint = location.protocol === 'file:' ? '
Hint: You are likely opening this HTML as a local file. Run a local server so fetch() can access PDFs.' : '';
        throw new Error('Network error fetching ' + path + ': ' + e.message + hint);
      }
    }); } catch (e) {
        const hint = location.protocol === 'file:' ? '
Hint: You are likely opening this HTML as a local file. Run a local server so fetch() can access PDFs.' : '';
        throw new Error('Network error fetching ' + path + ': ' + e.message + hint);
      }
      if (!res.ok) {
        throw new Error('HTTP ' + res.status + ' fetching ' + path + ' — check filename, path, and hosting.');
      }
      return new Uint8Array(await res.arrayBuffer());
    }

    function toUSDate(iso) {
      // yyyy-mm-dd -> mm/dd/yyyy
      const [y, m, d] = iso.split('-');
      return `${m}/${d}/${y}`;
    }

    async function fillAndDownload(path, data, outName) {
      const { PDFDocument } = PDFLib;
      const bytes = await fetchTemplateBytes(path);
      const pdfDoc = await PDFDocument.load(bytes);
      const form = pdfDoc.getForm();
      try {
        const fields = form.getFields();
        if (!fields || fields.length === 0) {
          throw new Error('This PDF has no AcroForm text fields. If your template is an XFA (LiveCycle) form, it cannot be filled by the browser. Convert to a standard AcroForm.');
        }
      } catch (e) {
        console.warn('Form check:', e.message);
        if (/no AcroForm/i.test(e.message) || /XFA/i.test(e.message)) {
          throw e; // escalate for user-friendly alert
        }
      }

      const mappings = {
        'Prepared By': data.preparedBy,
        'Prepared For': data.preparedFor,
        'Effective Date#0': data.effectiveDate,
        'Agent/Broker Name': data.agentName,
        'Agent/Broker Details': data.agentDetails,
        'Account Name': data.accountName,
        'Eligible Lives': data.eligibleLives,
        'SIC': data.sic,
        'Situs State': data.situsState,
        'Effective Date#1': data.effectiveDate
      };

      // Try to set each field if it exists; ignore if missing
      Object.entries(mappings).forEach(([fieldName, value]) => {
        try {
          if (value == null || value === '') return;
          const field = form.getFieldMaybe ? form.getFieldMaybe(fieldName) : null;
          if (field && field.setText) {
            field.setText(String(value));
          } else {
            // Fallback: attempt direct getTextField
            try { form.getTextField(fieldName).setText(String(value)); } catch (e) {}
          }
        } catch (e) {
          // Silently continue if field is not present in that template
        }
      });

      form.flatten();

      // --- Footer date on pages 2+ (bottom-left) ---
      try {
        const { StandardFonts, rgb } = PDFLib;
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const pages = pdfDoc.getPages();
        if (pages.length > 1) {
          const now = new Date();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const dd = String(now.getDate()).padStart(2, '0');
          const yyyy = String(now.getFullYear());
          const dateText = `${mm}/${dd}/${yyyy}`;
          const size = 10;
          const margin = 24; // distance from edges
          const end = Math.min(pages.length, 10); // pages 2..10 (index 1..9)
          for (let i = 1; i < end; i++) {
            const page = pages[i];
            page.drawText(dateText, {
              x: margin,
              y: margin,
              size,
              font,
              color: rgb(0.1, 0.1, 0.1),
              opacity: 0.9
            });
          }
        }
      } catch (e) {
        console.warn('Footer date stamp skipped:', e.message);
      }

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });

      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${outName} Proposal.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(link.href);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const type = fd.get('type') || 'direct';
      const employees = Number(fd.get('employees'));
      if (!employees || employees < 3) {
        alert('Please enter a valid employee count (minimum 3).');
        return;
      }

      if (location.protocol === 'file:') {
        document.getElementById('envWarn').style.display = '';
      }

      const path = computeTemplatePath(employees, type);

      const accountName = (fd.get('Account Name') || '').toString().trim();
      if (!accountName) { alert('Account Name is required.'); return; }

      const data = {
        preparedBy: fd.get('Prepared By') || '',
        preparedFor: fd.get('Prepared For') || '',
        effectiveDate: fd.get('Effective Date') ? toUSDate(fd.get('Effective Date')) : '',
        agentName: fd.get('Agent/Broker Name') || '',
        agentDetails: fd.get('Agent/Broker Details') || '',
        accountName,
        eligibleLives: fd.get('Eligible Lives') || '',
        sic: fd.get('SIC') || '',
        situsState: fd.get('Situs State') || ''
      };

      templateHint.innerHTML = 'Generating from <strong>' + path.replace(TEMPLATES_DIR, '') + '</strong>…';

      try {
        await fillAndDownload(path, data, accountName);
        templateHint.innerHTML = 'Done! Downloaded: <strong>' + accountName + ' Proposal.pdf</strong>';
      } catch (err) {
        console.error('[ProposeNow] Generate error:', err);
        alert('Error generating PDF: ' + err.message + '
Open the console for details (Ctrl/Cmd+Shift+J).');
        templateHint.textContent = 'Error: ' + err.message;
      }
    });

    // --- Self test for template reachability ---
    document.getElementById('selfTestBtn').addEventListener('click', async () => {
      const out = document.getElementById('selfTestOut');
      out.style.display = '';
      out.innerHTML = 'Testing access to templates in <code>' + TEMPLATES_DIR + '</code>…';
      const tests = [
        TEMPLATE_FILES.small.direct,
        TEMPLATE_FILES.small.partner,
        TEMPLATE_FILES.mid.direct,
        TEMPLATE_FILES.mid.partner,
        TEMPLATE_FILES.large.direct,
        TEMPLATE_FILES.large.partner
      ].map(f => (/^https?:\/\//i.test(f) ? f : (TEMPLATES_DIR + f)));
      const labels = [
        '3-99 Direct', '3-99 Partner', '100-249 Direct', '100-249 Partner', 'Over 250 Direct', 'Over 250 Partner'
      ];
      const lines = [];
      for (let i = 0; i < tests.length; i++) {
        const url = tests[i];
        try {
          await fetchTemplateBytes(url);
          lines.push('✅ <span class="ok">OK</span> ' + labels[i] + ' — ' + url);
        } catch (e) {
          lines.push('❌ <span class="bad">FAIL</span> ' + labels[i] + ' — ' + e.message + '<br><code>' + url + '</code>');
        }
      }
      if (location.protocol === 'file:') {
        lines.unshift('⚠️ You are running from <code>file://</code>. Start a local server so the browser can fetch PDFs: <code>python -m http.server</code>');
      }
      out.innerHTML = lines.join('<br>');
    });
  </script>
</body>
</html>
